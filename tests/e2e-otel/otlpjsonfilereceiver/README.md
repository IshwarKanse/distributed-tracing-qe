# OpenTelemetry OTLP JSON File Receiver Test

This test demonstrates the OpenTelemetry OTLP JSON File receiver configuration for reading telemetry data from JSON files.

## üéØ What This Test Does

The test validates a complete file-based telemetry pipeline:
- One collector exports traces to a JSON file using the file exporter
- Another collector reads that JSON file using the OTLP JSON file receiver
- Traces are then forwarded to Tempo for verification

## üìã Test Resources

### 1. Tempo Monolithic Instance
```yaml
apiVersion: tempo.grafana.com/v1alpha1
kind: TempoMonolithic
metadata:
  name: jsonrecv
spec:
  jaegerui:
    enabled: true
    route:
      enabled: true
```

### 2. Persistent Volume Claim
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app.kubernetes.io/name: otel
  name: otlp-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
```

### 3. File Exporter Collector
```yaml
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: fileexporter
spec:
  image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib:0.129.1
  config: |
    receivers:
      otlp:
        protocols:
          grpc:

    processors:

    exporters:
      debug:
      file:
        path: /telemetry-data/telemetrygen-traces.json

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: []
          exporters: [debug,file]
  volumes:
    - name: file
      persistentVolumeClaim:
        claimName: otlp-data
  volumeMounts: 
    - name: file
      mountPath: /telemetry-data
```

### 4. OTLP JSON File Receiver Collector
```yaml
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otlpjsonfile
spec:
  image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib:0.129.1
  config: |
    receivers:
      otlpjsonfile:
        include:
          - "/telemetry-data/*.json"

    processors:

    exporters:
      debug:
      otlp:
        endpoint: tempo-jsonrecv:4317
        tls:
          insecure: true

    service:
      pipelines:
        traces:
          receivers: [otlpjsonfile]
          processors: []
          exporters: [debug,otlp]
  volumes:
    - name: file
      persistentVolumeClaim:
        claimName: otlp-data
  volumeMounts: 
    - name: file
      mountPath: /telemetry-data
      readOnly: true
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/component: opentelemetry-collector
              app.kubernetes.io/managed-by: opentelemetry-operator
              app.kubernetes.io/name: fileexporter-collector
          topologyKey: "kubernetes.io/hostname"
```

### 5. Trace Generator Job
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: generate-traces
spec:
  template:
    spec:
      containers:
      - name: telemetrygen
        image: ghcr.io/open-telemetry/opentelemetry-collector-contrib/telemetrygen:v0.129.0
        args:
        - traces
        - --otlp-endpoint=fileexporter-collector:4317
        - --otlp-insecure=true
        - --traces=5
        - --service=from-otlp-jsonfile
      restartPolicy: Never
  backoffLimit: 4
```

### 6. Trace Verification Job
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-traces
spec:
  template:
    spec:
      containers:
      - name: verify-traces
        image: ghcr.io/grafana/tempo-operator/test-utils:main
        command:
        - /bin/bash
        - -eux
        - -c
        args:
        - |
          curl -v -G http://tempo-jsonrecv-jaegerui:16686/api/traces --data-urlencode "service=from-otlp-jsonfile" | tee /tmp/jaeger.out
          num_traces=$(jq ".data | length" /tmp/jaeger.out)
          if [[ "$num_traces" -ne 5 ]]; then
            echo && echo "The Jaeger API returned $num_traces instead of 10 traces."
            exit 1
          fi
      restartPolicy: Never
```

## üöÄ Test Steps

1. **Create Tempo Instance** - Deploy Tempo with Jaeger UI for trace verification
2. **Create PVC** - Create shared storage for file-based trace exchange
3. **Create File Exporter Collector** - Deploy collector that exports traces to JSON files
4. **Create OTLP JSON File Receiver Collector** - Deploy collector that reads JSON files and forwards to Tempo
5. **Generate Traces** - Run telemetrygen to create 5 test traces
6. **Verify Traces** - Check that all traces are received in Tempo via Jaeger API

## üîç Verification

The test verification confirms:
- 5 traces are generated by telemetrygen
- Traces are successfully written to JSON file by file exporter
- OTLP JSON file receiver successfully reads the JSON file
- All 5 traces are received and stored in Tempo
- Traces are queryable via Jaeger API with service name "from-otlp-jsonfile"

## üßπ Cleanup

The test runs in the default namespace and all resources are cleaned up automatically when the test completes.

## üìù Key Configuration Notes

- Uses shared PVC for file-based communication between collectors
- File exporter writes to `/telemetry-data/telemetrygen-traces.json`
- OTLP JSON file receiver monitors `/telemetry-data/*.json` pattern
- Pod affinity ensures both collectors run on the same node for shared volume access
- Read-only mount for OTLP JSON file receiver to prevent accidental file modification
- Demonstrates end-to-end file-based telemetry pipeline with Tempo integration 